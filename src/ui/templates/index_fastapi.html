<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-RAG Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/static/custom.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', 'Roboto', 'DM Sans', sans-serif;
            background-color: #fafafa;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar styles - exact copy from Streamlit version */
        .sidebar {
            width: 300px;
            background-color: #23272F;
            color: white;
            padding: 1rem;
            overflow-y: auto;
        }

        .sidebar-section {
            background: none;
            padding: 0;
            border-radius: 0;
            margin: 1rem 0;
            border-bottom: 0.5px solid #444857;
            margin-bottom: 1.2rem;
            padding-bottom: 0.8rem;
        }

        .sidebar h2 {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .sidebar h3 {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            color: #fff;
        }

        .sidebar i {
            color: #888;
            margin-right: 8px;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow: hidden;
        }

        /* Header styles - exact copy from Streamlit version */
        .main-header {
            background: #2D3748;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            color: white;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .main-header h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
        }

        /* Technique card styles - exact copy from Streamlit version */
        .technique-card {
            background: #f8f9fa;
            color: #2c3e50;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .technique-card strong {
            color: #1a202c;
            font-weight: bold;
        }

        .technique-card small {
            color: #4a5568;
            line-height: 1.4;
        }

        /* Message styles - exact copy from Streamlit version */
        .message-user {
            background: #e3f2fd;
            color: #1565c0;
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
            border-left: 4px solid #2196f3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .message-user strong {
            color: #0d47a1;
            font-weight: bold;
        }

        .message-bot {
            background: #f3e5f5;
            color: #6a1b9a;
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
            border-left: 4px solid #9c27b0;
            box-shadow: 0 2px 8px rgba(156, 39, 176, 0.1);
        }

        .message-bot strong {
            color: #4a148c;
            font-weight: bold;
        }

        .technique-badge {
            background: #667eea;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Chat session styles - exact copy from Streamlit version */
        .chat-session-btn {
            display: block;
            width: 100%;
            text-align: left;
            background:#2D3340;
            color: #F1F3F5;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            font-size: 15px;
            font-family: 'Inter', 'Segoe UI', 'Roboto', 'DM Sans', sans-serif;
            transition: background 0.2s, color 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .chat-session-btn.selected,
        .chat-session-btn:active {
            background: #4C6EF5;
            color: #fff;
            font-weight: 600;
        }

        .chat-session-btn:hover {
            background: #3B4252;
            color: #A5B4FC;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: #4C6EF5;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3b57d4;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Chat input area */
        .chat-input-container {
            position: fixed;
            bottom: 0;
            left: 300px;
            right: 0;
            background: white;
            padding: 1rem 2rem;
            border-top: 1px solid #ddd;
            z-index: 100;
            box-shadow: 0px -2px 10px rgba(0,0,0,0.05);
        }

        .chat-input-row {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .chat-input {
            flex: 1;
        }

        .technique-select {
            min-width: 180px;
        }

        .chat-input textarea {
            min-height: 60px;
            resize: vertical;
        }

        /* Messages container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 120px; /* Space for fixed input */
            padding-right: 1rem;
            position: relative;
            height: calc(100vh - 280px); /* Adjust based on header and input heights */
            padding-bottom: 1.5rem;
            scrollbar-width: thin;
        }
        
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        /* Info boxes */
        .info-box {
            background-color: #f0f7fb;
            color: #23272F;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #0096c7;
            margin: 1rem 0;
        }

        /* Loading spinner */
        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4C6EF5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* CRAG checkbox styling */
        .crag-options {
            background-color: #e8f0fe;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4c6ef5;
        }

        .crag-options h5 {
            margin-bottom: 5px;
            color: #4a4a4a;
        }

        .crag-options label {
            font-size: 15px;
            font-weight: 500;
            color: #1a73e8;
        }

        /* Upload area */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            transition: border-color 0.2s;
        }

        .upload-area:hover {
            border-color: #4C6EF5;
        }

        .upload-area.dragover {
            border-color: #4C6EF5;
            background-color: #f8f9ff;
        }

        /* Source Documents UI */
        .source-documents {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .source-documents h5 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 16px;
        }

        .source-document-card {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .source-document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .chunk-count {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .source-document-actions {
            margin: 0.5rem 0;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .source-action-btn {
            display: inline-block;
            padding: 6px 12px;
            font-size: 12px;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .source-action-btn.view_document {
            background: #007bff;
            color: white;
        }

        .source-action-btn.view_document:hover {
            background: #0056b3;
            color: white;
            text-decoration: none;
        }

        .source-action-btn.download_document {
            background: #6c757d;
            color: white;
        }

        .source-action-btn.download_document:hover {
            background: #545b62;
            color: white;
            text-decoration: none;
        }

        /* Add to your CSS */
        .source-action-btn.download_highlighted {
            background: #28a745;
            color: white;
        }

        .source-action-btn.download_highlighted:hover {
            background: #218838;
            color: white;
            text-decoration: none;
        }
        .source-chunks-preview {
            margin-top: 0.5rem;
        }

        /* Add this to your CSS in index_fastapi.html */
        .source-action-btn.view_highlighted {
            background: #17a2b8;
            color: white;
        }

        .source-action-btn.view_highlighted:hover {
            background: #138496;
            color: white;
            text-decoration: none;
        }

        .chunk-preview {
            background: #f1f3f4;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
            font-size: 13px;
        }

        .chunk-score {
            display: inline-block;
            background: #ffc107;
            color: #856404;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .chunk-content {
            color: #495057;
            line-height: 1.4;
        }

        .more-chunks {
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 4px;
        }

        /* Sidebar dark theme */
        .sidebar {
            background-color: #23272F;
            color: #ffffff;
        }
        
        .sidebar a, .sidebar button {
            color: #f1f3f5;
        }
        
        .sidebar h3, .sidebar h2 {
            color: #ffffff;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
            }
            
            .chat-input-container {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Navigation -->
            <div class="sidebar-section">
                <h2><i class="fa-solid fa-compass"></i>Navigation</h2>
                <div class="form-group">
                    <label>
                        <input type="radio" name="page" value="chat" checked onchange="switchPage(this.value)"> Chat
                    </label>
                    <label>
                        <input type="radio" name="page" value="analytics" onchange="switchPage(this.value)"> Analytics Dashboard
                    </label>
                </div>
            </div>

            <!-- Document Upload -->
            <div class="sidebar-section">
                <h3><i class="fa-solid fa-folder-open"></i>Document Upload</h3>
                <div class="upload-area" id="uploadArea">
                    <i class="fa-solid fa-cloud-upload-alt" style="font-size: 2rem; color: #ccc;"></i>
                    <p>Drag & drop files here or click to browse</p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.txt,.csv,.json,.docx,.xlsx" style="display: none;">
                </div>
                <div id="uploadedFiles"></div>
            </div>

            <!-- RAG Technique Description -->
            <div class="sidebar-section">
                <h3><i class="fa-solid fa-cogs"></i>RAG Technique</h3>
                <div class="technique-card" id="techniqueDescription">
                    <strong>CRAG</strong><br>
                    <small>{{ crag_description }}</small>
                </div>
            </div>

            <!-- Session Management -->
            <div class="sidebar-section">
                <h3><i class="fa-regular fa-floppy-disk"></i>Session Management</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="clearChat()">✕ Clear Chat</button>
                    <button class="btn btn-secondary" onclick="recoverLast()">↻ Recover Last</button>
                </div>
            </div>

            <!-- Individual Message Management -->
            <div class="sidebar-section" id="messageManagement" style="display: none;">
                <h3><i class="fa-solid fa-list-check"></i>Individual Message Management</h3>
                <div class="info-box">
                    <p><strong><i class="fa-regular fa-lightbulb"></i> Tip:</strong> 
                    Click the <i class="fa-solid fa-trash-can"></i> button next to any question to delete that specific question and its response, including any ratings you gave.</p>
                    <p>This is useful for:</p>
                    <ul>
                        <li>Removing test questions</li>
                        <li>Cleaning up incorrect queries</li>
                        <li>Managing chat history length</li>
                    </ul>
                </div>
                <div id="sessionInfo"></div>
            </div>

            <!-- Chat Sessions -->
            <div class="sidebar-section">
                <h3><i class="fa-regular fa-comments"></i>Chat Sessions</h3>
                <div class="form-group">
                    <input type="text" class="form-control" placeholder="Search chats..." id="chatSearch" oninput="filterSessions()">
                </div>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="createNewSession()" style="flex: 1;">+ New Chat</button>
                    <button class="btn btn-secondary" onclick="refreshSessions()">↻</button>
                </div>
                <div id="chatSessions"></div>
            </div>

            <!-- Analytics -->
            <div class="sidebar-section">
                <h3><i class="fa-solid fa-chart-bar"></i>Analytics</h3>
                <button class="btn btn-danger" onclick="clearAnalytics()">Clear Analytics</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="main-header">
                <h1>
                    <i class="fa-solid fa-robot" style="color:#888;margin-right:12px;"></i>
                    Multi-RAG Chatbot with Evaluation
                </h1>
                <p>Compare different RAG techniques with your documents and get comprehensive analytics</p>
            </div>

            <!-- Chat Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; background-color: #ffffff; padding: 0.5rem 0; position: sticky; top: 0; z-index: 99;">
                <h2><i class="fa-regular fa-comments" style="color:#888;margin-right:8px;"></i>Chat</h2>
                <div id="sessionStatus">💾 Session ready</div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <div class="info-box">
                    👋 Welcome! Upload documents and start asking questions using different RAG techniques.
                </div>
            </div>
        </div>

        <!-- Chat Input (Fixed at bottom) -->
        <div class="chat-input-container">
            <!-- CRAG Options (shown conditionally) -->
            <div class="crag-options" id="cragOptions" style="display: none;">
                <h5>🌐 CRAG Web Search Options</h5>
                <label>
                    <input type="checkbox" id="cragWebSearch" checked> Enable web search fallback
                </label>
                <small>If enabled, CRAG will use web search when your document is insufficient.</small>
            </div>

            <div class="chat-input-row">
                <div class="chat-input">
                    <textarea class="form-control" id="queryInput" placeholder="Ask a question about your documents..." rows="2"></textarea>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="sendQuery()" id="sendButton">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
    let currentSessionId = '{{ session_id }}';
    let uploadedDocuments = {{ uploaded_documents | tojson | safe }};
    let messages = {{ messages | tojson | safe }};
    let cragDescription = "{{ crag_description }}";

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            updateMessages();
            updateSessionInfo();
            loadChatSessions();
            updateTechnique();
            
            // Setup file upload
            setupFileUpload();
            
            // Setup enter key for query input
            document.getElementById('queryInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendQuery();
                }
            });
        });

        function updateMessages() {
            const container = document.getElementById('messagesContainer');
            if (messages.length === 0) {
                container.innerHTML = '<div class="info-box">👋 Welcome! Upload documents and start asking questions using different RAG techniques.</div>';
                return;
            }

            let html = '';
            messages.forEach((message, index) => {
                if (message.role === 'user') {
                    html += `
                        <div style="display: flex; margin: 0.5rem 0;">
                            <div style="flex: 1;">
                                <div class="message-user">
                                    <strong>You:</strong> ${message.content}
                                    <br><small>${new Date(message.timestamp).toLocaleTimeString()}</small>
                                </div>
                            </div>
                            <div style="width: 40px; text-align: center;">
                                <button class="btn btn-danger" onclick="deleteMessage('${message.id}')" style="padding: 0.25rem; font-size: 12px;">✕</button>
                            </div>
                        </div>
                    `;
                } else {
                    const techniqueBadge = message.technique ? `<span class="technique-badge">${message.technique}</span>` : '';
                    html += `
                        <div class="message-bot">
                            <strong>Assistant:</strong> ${techniqueBadge}
                            <br>${message.content}
                            <br><small>${new Date(message.timestamp).toLocaleTimeString()}</small>
                        </div>
                    `;

                    // Add source documents UI if available
                    if (message.source_documents_ui && message.source_documents_ui.length > 0) {
                        html += `<div class="source-documents">`;
                        html += `<h5><i class="fas fa-file-alt"></i> Source Documents</h5>`;
                        
                        message.source_documents_ui.forEach(doc => {
                            html += `
                                <div class="source-document-card">
                                    <div class="source-document-header">
                                        <strong>📄 ${doc.doc_name}</strong>
                                        <span class="chunk-count">${doc.chunk_count} chunks (avg score: ${doc.avg_score})</span>
                                    </div>
                                    <div class="source-document-actions">
                                        ${doc.actions.map(action => {
                                            if (action.type === 'link' && action.enabled) {
                                                let buttonClass = 'source-action-btn ' + action.action;
                                                if (action.action === 'download_highlighted') {
                                                    buttonClass += ' highlighted-download';
                                                }
                                                return `<a href="${action.url}" target="${action.target}" class="${buttonClass}">${action.label}</a>`;
                                            }
                                            return '';
                                        }).join('')}
                                    </div>
                                    <div class="source-chunks-preview">
                                        ${doc.chunks.slice(0, 2).map(chunk => `
                                            <div class="chunk-preview">
                                                <span class="chunk-score">Score: ${chunk.score}</span>
                                                <div class="chunk-content">${chunk.content.substring(0, 150)}${chunk.content.length > 150 ? '...' : ''}</div>
                                            </div>
                                        `).join('')}
                                        ${doc.chunks.length > 2 ? `<div class="more-chunks">+${doc.chunks.length - 2} more chunks...</div>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }

                    // Add feedback form if pending
                    if (message.query_id) {
                        html += `
                            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <h4>📝 Rate this response</h4>
                                <p>Help us improve by rating this response:</p>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label>Helpfulness: <input type="range" min="1" max="5" value="3" id="helpfulness_${message.id}"></label>
                                        <label>Accuracy: <input type="range" min="1" max="5" value="3" id="accuracy_${message.id}"></label>
                                    </div>
                                    <div>
                                        <label>Clarity: <input type="range" min="1" max="5" value="3" id="clarity_${message.id}"></label>
                                        <label>Overall: <input type="range" min="1" max="5" value="3" id="overall_${message.id}"></label>
                                    </div>
                                </div>
                                <textarea placeholder="Additional comments (optional)" id="comments_${message.id}" style="width: 100%; margin: 0.5rem 0;"></textarea>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-primary" onclick="submitFeedback('${message.query_id}', '${message.id}')">Submit Feedback</button>
                                    <button class="btn btn-secondary" onclick="skipFeedback('${message.query_id}')">Skip</button>
                                </div>
                            </div>
                        `;
                    }
                }
            });

            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function updateSessionInfo() {
            const userMessages = messages.filter(m => m.role === 'user').length;
            const assistantMessages = messages.filter(m => m.role === 'assistant').length;
            const ratedMessages = messages.filter(m => m.role === 'assistant' && m.query_id).length;

            if (messages.length > 0) {
                document.getElementById('messageManagement').style.display = 'block';
                document.getElementById('sessionInfo').innerHTML = `
                    <strong>Current Session:</strong><br>
                    - <i class="fa-regular fa-comments"></i> ${userMessages} questions asked<br>
                    - <i class="fa-solid fa-robot"></i> ${assistantMessages} responses given<br>
                    - <i class="fa-solid fa-chart-bar"></i> ${ratedMessages} responses available for rating
                `;
                document.getElementById('sessionStatus').textContent = `💾 Auto-saved (${messages.length} msgs)`;
            } else {
                document.getElementById('messageManagement').style.display = 'none';
                document.getElementById('sessionStatus').textContent = '💾 Session ready';
            }
        }

        function updateTechnique() {
            // Update technique description for CRAG only
            document.getElementById('techniqueDescription').innerHTML = `
                <strong>CRAG</strong><br>
                <small>${cragDescription}</small>
            `;

            // Always show CRAG options since we only use CRAG
            const cragOptions = document.getElementById('cragOptions');
            cragOptions.style.display = 'block';
        }

        async function sendQuery() {
            const queryInput = document.getElementById('queryInput');
            const query = queryInput.value.trim();
            
            if (!query) return;
            if (uploadedDocuments.length === 0) {
                alert('Please upload documents first!');
                return;
            }

            const technique = "CRAG"; // Always use CRAG
            const cragWebSearch = document.getElementById('cragWebSearch').checked;

            // Add user message immediately
            const userMessage = {
                id: Date.now().toString(),
                role: 'user',
                content: query,
                timestamp: new Date().toISOString()
            };
            messages.push(userMessage);
            updateMessages();
            updateSessionInfo();

            // Clear input
            queryInput.value = '';

            // Show loading
            const container = document.getElementById('messagesContainer');
            container.innerHTML += '<div class="loading"><div class="spinner"></div><p>Generating response...</p></div>';

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        technique: technique,
                        session_id: currentSessionId,
                        crag_web_search_enabled: cragWebSearch
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Add assistant message
                    const assistantMessage = {
                        id: Date.now().toString() + '_assistant',
                        role: 'assistant',
                        content: data.response,
                        technique: data.technique,
                        query_id: data.query_id,
                        timestamp: new Date().toISOString(),
                        source_documents_ui: data.source_documents_ui || []
                    };
                    messages.push(assistantMessage);
                } else {
                    // Add error message
                    const errorMessage = {
                        id: Date.now().toString() + '_error',
                        role: 'assistant',
                        content: `Error: ${data.error}`,
                        timestamp: new Date().toISOString()
                    };
                    messages.push(errorMessage);
                }
            } catch (error) {
                console.error('Error:', error);
                const errorMessage = {
                    id: Date.now().toString() + '_error',
                    role: 'assistant',
                    content: `Error: ${error.message}`,
                    timestamp: new Date().toISOString()
                };
                messages.push(errorMessage);
            }

            updateMessages();
            updateSessionInfo();
        }

        async function submitFeedback(queryId, messageId) {
            const helpfulness = document.getElementById(`helpfulness_${messageId}`).value;
            const accuracy = document.getElementById(`accuracy_${messageId}`).value;
            const clarity = document.getElementById(`clarity_${messageId}`).value;
            const overall = document.getElementById(`overall_${messageId}`).value;
            const comments = document.getElementById(`comments_${messageId}`).value;

            try {
                const response = await fetch('/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query_id: queryId,
                        helpfulness: parseInt(helpfulness),
                        accuracy: parseInt(accuracy),
                        clarity: parseInt(clarity),
                        overall_rating: parseInt(overall),
                        comments: comments
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Thank you for your feedback!');
                    // Remove the query_id to hide the feedback form
                    const message = messages.find(m => m.query_id === queryId);
                    if (message) {
                        delete message.query_id;
                        updateMessages();
                    }
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('Error submitting feedback');
            }
        }

        function skipFeedback(queryId) {
            // Remove the query_id to hide the feedback form
            const message = messages.find(m => m.query_id === queryId);
            if (message) {
                delete message.query_id;
                updateMessages();
            }
        }

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFileUpload(files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFileUpload(e.target.files);
            });
        }

        async function handleFileUpload(files) {
            const formData = new FormData();
            formData.append('session_id', currentSessionId);

            for (let file of files) {
                formData.append('files', file);
            }

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    uploadedDocuments = data.files;
                    updateUploadedFiles();
                    alert(data.message);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Error uploading files');
            }
        }

        function updateUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            if (uploadedDocuments.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="margin-top: 1rem;"><strong>Uploaded Files:</strong><ul>';
            uploadedDocuments.forEach(file => {
                html += `<li>📄 ${file}</li>`;
            });
            html += '</ul></div>';
            container.innerHTML = html;
        }

        async function loadChatSessions() {
            try {
                const response = await fetch('/sessions');
                const sessions = await response.json();
                
                const container = document.getElementById('chatSessions');
                if (sessions.length === 0) {
                    container.innerHTML = '<div class="info-box">No chat sessions yet. Start a new chat!</div>';
                    return;
                }

                let html = '<div><strong>Select a chat:</strong></div>';
                sessions.forEach(session => {
                    const isActive = session.session_id === currentSessionId;
                    html += `
                        <div class="chat-session-item">
                            <button class="chat-session-btn ${isActive ? 'selected' : ''}" 
                                    onclick="switchToSession('${session.session_id}')">
                                ${session.title}
                            </button>
                            <div class="session-actions">
                                <button class="session-action-btn" onclick="renameSession('${session.session_id}', '${session.title}')" title="Rename">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="session-action-btn" onclick="deleteSession('${session.session_id}')" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        async function createNewSession() {
            try {
                const response = await fetch('/sessions/new', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = data.session_id;
                    messages = [];
                    uploadedDocuments = [];
                    updateMessages();
                    updateSessionInfo();
                    updateUploadedFiles();
                    loadChatSessions();
                    alert('New chat session created!');
                }
            } catch (error) {
                console.error('Error creating session:', error);
            }
        }

        async function switchToSession(sessionId) {
            try {
                const response = await fetch('/sessions/switch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = sessionId;
                    messages = data.messages || [];
                    updateMessages();
                    updateSessionInfo();
                    loadChatSessions();
                } else {
                    console.error('Error switching session:', data.message);
                    alert('Failed to switch session: ' + data.message);
                }
            } catch (error) {
                console.error('Error switching session:', error);
                alert('Failed to switch session');
            }
        }

        async function renameSession(sessionId, currentTitle) {
            const newTitle = prompt("Enter a new name for this chat session:", currentTitle);
            if (newTitle && newTitle !== currentTitle) {
                try {
                    const response = await fetch(`/sessions/${sessionId}/rename`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title: newTitle })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        loadChatSessions();
                        if (sessionId === currentSessionId) {
                            // Update the current session title if it's the active one
                            updateSessionInfo();
                        }
                    } else {
                        alert('Failed to rename session: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error renaming session:', error);
                    alert('Failed to rename session');
                }
            }
        }
        
        async function deleteSession(sessionId) {
            if (confirm('Are you sure you want to delete this chat session? This cannot be undone.')) {
                try {
                    const response = await fetch(`/sessions/${sessionId}`, {
                        method: 'DELETE'
                    });
                    
                    // If this was the current session, create a new one
                    if (sessionId === currentSessionId) {
                        createNewSession();
                    } else {
                        loadChatSessions();
                    }
                } catch (error) {
                    console.error('Error deleting session:', error);
                    alert('Failed to delete session');
                }
            }
        }

        function refreshSessions() {
            loadChatSessions();
        }

        function clearChat() {
            if (confirm('Are you sure you want to clear the current chat?')) {
                messages = [];
                updateMessages();
                updateSessionInfo();
            }
        }

        function recoverLast() {
            // This would need backend implementation
            alert('Recover last session feature would be implemented here');
        }

        function clearAnalytics() {
            if (confirm('Are you sure you want to clear ALL analytics data?')) {
                // This would need backend implementation
                alert('Clear analytics feature would be implemented here');
            }
        }

        function switchPage(page) {
            if (page === 'analytics') {
                // This would show analytics dashboard
                alert('Analytics dashboard would be shown here');
            }
        }

        function filterSessions() {
            // This would filter the sessions based on search input
            const searchTerm = document.getElementById('chatSearch').value.toLowerCase();
            // Implementation would filter the sessions list
        }

        function deleteMessage(messageId) {
            if (confirm('Delete this question and response?')) {
                // Remove the message and potentially the following assistant message
                const messageIndex = messages.findIndex(m => m.id === messageId);
                if (messageIndex !== -1) {
                    messages.splice(messageIndex, 1);
                    // If next message is assistant response, remove it too
                    if (messageIndex < messages.length && messages[messageIndex].role === 'assistant') {
                        messages.splice(messageIndex, 1);
                    }
                    updateMessages();
                    updateSessionInfo();
                }
            }
        }

        // Initialize uploaded files display
        updateUploadedFiles();
    </script>
</body>
</html>